---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
vars:
  TALOS_RESOURCES_DIR: "{{.ROOT_DIR}}/talos/main"
  TALOS_KUBE_VIP: "192.168.130.130"
  OUTPUT_DIR: "{{.TALOS_RESOURCES_DIR}}/out"
  TALOS_VERSION: "v1.12.1"
  REMOTE_ASSETS_DIR: "/mnt/olympia/docker/netbootxyz/assets/talos"

tasks:
  gen-all:
    desc: Generate machine configs
    dir: "{{.TALOS_RESOURCES_DIR}}"
    deps:
      - gen-controlplane
      - gen-worker
      # - gen-talosconfig
    cmds:
      - mv out/dorn.yaml pxe/00:e0:4c:38:72:38
      - mv out/fulgrim.yaml pxe/98:b7:85:1e:d8:ad
      - mv out/guilliman.yaml pxe/58:47:ca:77:75:22
      - mv out/horus.yaml pxe/00:e0:4c:38:72:38
      - mv out/lion.yaml pxe/00:e0:4c:38:75:a7
      - mv out/magnus.yaml pxe/00:e0:4c:38:78:14
      - mv out/sanguinius.yaml pxe/58:47:ca:76:b6:f1
      - scp -r pxe/* perturabo:{{.REMOTE_ASSETS_DIR}}/machineconfig/
    preconditions:
      - which talosctl sops

  gen-controlplane:
    desc: Generate Control Plane Configs
    dir: "{{.TALOS_RESOURCES_DIR}}"
    deps:
      - make-output
    cmds:
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @controlplane/cp.patch.yaml \
          --config-patch @controlplane/horus.patch.yaml \
          --output-types controlplane \
          --output {{.OUTPUT_DIR}}/horus.yaml
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @controlplane/cp.patch.yaml \
          --config-patch @controlplane/magnus.patch.yaml \
          --output-types controlplane \
          --output {{.OUTPUT_DIR}}/magnus.yaml
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @controlplane/cp.patch.yaml \
          --config-patch @controlplane/lion.patch.yaml \
          --output-types controlplane \
          --output {{.OUTPUT_DIR}}/lion.yaml
    preconditions:
      - which talosctl sops

  gen-worker:
    desc: Generate Worker Configs
    dir: "{{.TALOS_RESOURCES_DIR}}"
    deps:
      - make-output
    cmds:
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @worker/worker.patch.yaml \
          --config-patch @worker/dorn.patch.yaml \
          --output-types worker \
          --output {{.OUTPUT_DIR}}/dorn.yaml
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @worker/worker.patch.yaml \
          --config-patch @worker/fulgrim.patch.yaml \
          --output-types worker \
          --output {{.OUTPUT_DIR}}/fulgrim.yaml
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @worker/worker.patch.yaml \
          --config-patch @worker/guilliman.patch.yaml \
          --output-types worker \
          --output {{.OUTPUT_DIR}}/guilliman.yaml
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --config-patch @all.patch.yaml \
          --config-patch @worker/worker.patch.yaml \
          --config-patch @worker/sanguinius.patch.yaml \
          --output-types worker \
          --output {{.OUTPUT_DIR}}/sanguinius.yaml
    preconditions:
      - which talosctl sops

  gen-talosconfig:
    desc: Generate Talos Config
    dir: "{{.TALOS_RESOURCES_DIR}}"
    deps:
      - make-output
    cmds:
      - |
        talosctl gen config main https://{{.TALOS_KUBE_VIP}}:6443 \
          --with-secrets <(sops -d secrets.enc.yaml) \
          --output-types talosconfig \
          --output {{.OUTPUT_DIR}}/talosconfig
    preconditions:
      - which talosctl sops

  rotate-secrets:
    desc: Destroys and creates new secrets
    dir: "{{.TALOS_RESOURCES_DIR}}"
    cmds:
      - talosctl gen secrets -o secrets.enc.yaml --force
      - sops -e -i secrets.enc.yaml
    preconditions:
      - which talosctl sops

  make-output:
    desc: make output dir
    dir: "{{.TALOS_RESOURCES_DIR}}"
    cmds:
      - mkdir -p {{.OUTPUT_DIR}}

  fetch-assets:
    desc: pull boot assets for talos
    dir: "{{.TALOS_RESOURCES_DIR}}"
    vars:
      FULGRIM_SCHEMATIC_ID:
        sh: curl -s -X POST --data-binary @{{.TALOS_RESOURCES_DIR}}/img/fulgrim.yaml https://factory.talos.dev/schematics | jq -r '.id'
      MS01_SCHEMATIC_ID:
        sh: curl -s -X POST --data-binary @{{.TALOS_RESOURCES_DIR}}/img/ms01.yaml https://factory.talos.dev/schematics | jq -r '.id'
      BMAXB3_SCHEMATIC_ID:
        sh: curl -s -X POST --data-binary @{{.TALOS_RESOURCES_DIR}}/img/bmaxb3.yaml https://factory.talos.dev/schematics | jq -r '.id'
    cmds:
      - |
        ssh perturabo \
        "curl -o {{.REMOTE_ASSETS_DIR}}/boot/fulgrim/kernel-amd64 https://factory.talos.dev/image/{{.FULGRIM_SCHEMATIC_ID}}/{{.TALOS_VERSION}}/kernel-amd64"
      - |
        ssh perturabo \
        "curl -o {{.REMOTE_ASSETS_DIR}}/boot/fulgrim/initramfs-amd64.xz https://factory.talos.dev/image/{{.FULGRIM_SCHEMATIC_ID}}/{{.TALOS_VERSION}}/initramfs-amd64.xz"
      - |
        ssh perturabo \
        "curl -o {{.REMOTE_ASSETS_DIR}}/boot/ms01/kernel-amd64 https://factory.talos.dev/image/{{.MS01_SCHEMATIC_ID}}/{{.TALOS_VERSION}}/kernel-amd64"
      - |
        ssh perturabo \
        "curl -o {{.REMOTE_ASSETS_DIR}}/boot/ms01/initramfs-amd64.xz https://factory.talos.dev/image/{{.MS01_SCHEMATIC_ID}}/{{.TALOS_VERSION}}/initramfs-amd64.xz"
      - |
        ssh perturabo \
        "curl -o {{.REMOTE_ASSETS_DIR}}/boot/bmaxb3/kernel-amd64 https://factory.talos.dev/image/{{.BMAXB3_SCHEMATIC_ID}}/{{.TALOS_VERSION}}/kernel-amd64"
      - |
        ssh perturabo \
        "curl -o {{.REMOTE_ASSETS_DIR}}/boot/bmaxb3/initramfs-amd64.xz https://factory.talos.dev/image/{{.BMAXB3_SCHEMATIC_ID}}/{{.TALOS_VERSION}}/initramfs-amd64.xz"

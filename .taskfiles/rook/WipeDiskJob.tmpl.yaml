---
apiVersion: batch/v1
kind: Job
metadata:
  name: "${jobName}"
  namespace: "kube-system"
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      automountServiceAccountToken: false
      restartPolicy: Never
      nodeName: ${node}
      containers:
        - name: disk-wipe
          image: docker.io/library/alpine:latest
          securityContext:
            privileged: true
          resources: {}
          command: ["/bin/sh", "-c"]
          args:
            - apk add --no-cache sgdisk util-linux parted hdparm;
              wipefs -a ${ceph_disk};
              sgdisk --zap-all ${ceph_disk};
              dd if=/dev/zero of="${ceph_disk}" count=200 oflag=direct seek=0;
              dd if=/dev/zero of="${ceph_disk}" count=200 oflag=direct seek=$((1 * 1024**2));
              dd if=/dev/zero of="${ceph_disk}" count=200 oflag=direct seek=$((10 * 1024**2));
              dd if=/dev/zero of="${ceph_disk}" count=200 oflag=direct seek=$((100 * 1024**2));
              echo "dd if=/dev/zero of="${ceph_disk}" bs=1k count=200 oflag=direct,dsync seek=$((1000 * 1024**2))";
              dd if=/dev/zero of="${ceph_disk}" count=200 oflag=direct seek=$((999 * 1024**2));
              blkdiscard -v ${ceph_disk};
              partprobe ${ceph_disk};

# ls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove %;
# rm -rf /dev/ceph-*;
# rm -rf /dev/mapper/ceph--*;

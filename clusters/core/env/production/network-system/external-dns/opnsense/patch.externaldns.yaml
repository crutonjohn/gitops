---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: external-dns
spec:
  values:
    fullnameOverride: ${APP}
    provider:
      name: webhook
      webhook:
        image:
          repository: ghcr.io/crutonjohn/external-dns-opnsense-webhook
          tag: v1.0.0
        env:
          - name: OPNSENSE_API_SECRET
            valueFrom:
              secretKeyRef:
                name: external-dns-opnsense-secret
                key: api_secret
          - name: OPNSENSE_API_KEY
            valueFrom:
              secretKeyRef:
                name: external-dns-opnsense-secret
                key: api_key
          - name: OPNSENSE_HOST
            valueFrom:
              secretKeyRef:
                name: external-dns-opnsense-secret
                key: host
          - name: OPNSENSE_SKIP_TLS_VERIFY
            value: "true"
          - name: LOG_LEVEL
            value: "info"
        livenessProbe:
          httpGet:
            path: /healthz
            port: http-webhook
          initialDelaySeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /readyz
            port: http-webhook
          initialDelaySeconds: 10
          timeoutSeconds: 5
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 100Mi
    logLevel: debug
    extraArgs:
      #- --ignore-ingress-tls-spec
      #- --annotation-filter=external-dns/private in (true)
      - --traefik-disable-legacy
      - --target-net-filter=${HOME_NETWORK_CIDR}
      - --target-net-filter=${HEADSCALE_NETWORK_CIDR}
      - --ingress-class=traefik-external
      - --ingress-class=traefik-internal
      - --managed-record-types=A
      - --managed-record-types=AAAA
      - --managed-record-types=TXT
    policy: sync
    registry: txt
    domainFilters: ["${FAMILY_DOMAIN}"]
    serviceMonitor:
      enabled: false
    rbac:
      additionalPermissions:
        - apiGroups: ["traefik.containo.us", "traefik.io"]
          resources: ["ingressroutes", "ingressroutetcps", "ingressrouteudps"]
          verbs: ["get", "watch", "list"]
    #extraVolumes:
    #  - name: alloy-config
    #    configMap:
    #      name: alloy-config
    #  - name: data
    #    emptyDir:
    #      medium: Memory
    #extraContainers:
    #  - name: alloy
    #    image: "grafana/alloy:v1.10.2"
    #    imagePullPolicy: IfNotPresent
    #    args:
    #      - "run"
    #      - "--server.http.listen-addr=0.0.0.0:12345"
    #      - "--storage.path=/var/lib/alloy/data"
    #      - "/etc/alloy/config/config.alloy"
    #    volumeMounts:
    #      - name: alloy-config
    #        mountPath: "/etc/alloy/config"
    #      - name: data
    #        mountPath: "/var/lib/alloy"
    #    securityContext:
    #      runAsUser: 65532
    #      runAsGroup: 65532
    #      fsGroup: 65532

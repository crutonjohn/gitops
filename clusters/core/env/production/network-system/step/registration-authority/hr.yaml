---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: step-request-authority
spec:
  interval: 4h
  chart:
    spec:
      chart: step-certificates
      version: 1.29.0
      sourceRef:
        kind: HelmRepository
        name: smallstep-charts
        namespace: flux-system
  values:
    podSecurityContext:
      runAsUser: 8833
      runAsNonRoot: true
      runAsGroup: 8833
      fsGroup: 8833
      seccompProfile:
        type: RuntimeDefault
    autocert:
      enabled: false
    bootstrap:
      enabled: false
    ca:
      db:
        enabled: true
        persistent: true
        existingClaim: step-request-authority-db
      init:
        containerSecurityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsUser: 8833
          capabilities:
            drop: ["ALL"]
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
      containerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsUser: 8833
        # runAsRoot: 0 runs the ca as root instead of the step user. This is required in
        # some storage provisioners.
        # runAsUser: 0
        capabilities:
          drop: ["ALL"]
          add: ["NET_BIND_SERVICE"]
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
    inject:
      config:
        files:
          ca.json:
            address: 0.0.0.0:9000
            authority:
              certificateAuthority: ${SMALLSTEP_CA_URL}
              certificateAuthorityFingerprint: ${SMALLSTEP_CA_FINGERPRINT}
              certificateIssuer:
                provisioner: registration-authority
                type: jwk
              provisioners:
                - name: acme
                  type: ACME
              type: stepcas
              policy:
                x509:
                  allow:
                    dns:
                      - "*.${FAMILY_DOMAIN}"
                      - "*.garage.${FAMILY_DOMAIN}"
                      - "*.s3.garage.${FAMILY_DOMAIN}"
                      - "*.web.garage.${FAMILY_DOMAIN}"
                      - "*.ord.${FAMILY_DOMAIN}"
                    ip:
                      - "${HEADSCALE_NETWORK_CIDR}"
                      - "${HOME_NETWORK_CIDR}"
                  allowWildcardNames: false
            crt: ""
            dnsNames:
              - ra.${FAMILY_DOMAIN}
              - step-request-authority-step-certificates.network-system.svc.cluster.local
            logger:
              format: json
              level: debug
            tls:
              cipherSuites:
                - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
                - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
                - TLS_AES_128_GCM_SHA256
              maxVersion: 1.3
              minVersion: 1.2
              renegotiation: false
          defaults.json:
            ca-url: ${SMALLSTEP_CA_URL}
            fingerprint: ${SMALLSTEP_CA_FINGERPRINT}
            redirect-url: ""
      enabled: true
      secrets:
        certificate_issuer:
          enabled: true
          password: ${SMALLSTEP_K8S_REGISTRATION_AUTHORITY_PASS_B64}
        ssh:
          enabled: false
        x509:
          enabled: false
    ingress:
      enabled: true
      annotations:
        # these don't work right now https://github.com/cert-manager/cert-manager/issues/3484
        # cert-manager.io/issuer-name: "step-issuer"
        # cert-manager.io/issuer-kind: "StepClusterIssuer"
        # cert-manager.io/issuer-group: "certmanager.step.sm"
        # traefik.ingress.kubernetes.io/router.entrypoints: websecure
        # traefik.ingress.kubernetes.io/router.tls: "true"
        external-dns.alpha.kubernetes.io/target: ${CLUSTER_LB_INGRESS_INTERNAL}
      ingressClassName: "traefik-internal"
      hosts:
        - host: ra.${FAMILY_DOMAIN}
          paths:
            - path: /
              service:
                identifier: app
                port: https
      tls:
        - hosts:
            - ra.${FAMILY_DOMAIN}
          secretName: registration-authority-tls
    service:
      type: ClusterIP
      port: 9000
      targetPort: 9000
      nodePort: ""
      annotations: {}
      externalIPs: []

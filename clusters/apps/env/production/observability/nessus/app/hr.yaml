---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nessus
spec:
  interval: 12h
  chart:
    spec:
      chart: app-template
      version: 3.1.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      nessus:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          nessus:
            image:
              repository: tenable/nessus
              tag: "10.9.3-ubuntu@sha256:079f472c51245b11e4633537e45c428d48ed67551bc3a2f76022e6bc56efe9af"
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
            envFrom:
              - secret: nessus-env
            # securityContext:
            #   fsGroup: ${APP_UID}
            #   runAsNonRoot: true
            #   runAsUser: ${APP_UID}
            #   runAsGroup: ${APP_UID}
            #   allowPrivilegeEscalation: false
            #   readOnlyRootFilesystem: false
            #   capabilities: { drop: ["ALL"] }
            resources:
              requests:
                memory: 128Mi
                cpu: 100m
              limits:
                memory: 5Gi
    persistence:
      # config:
      #   existingClaim: esphome-config
      #   advancedMounts:
      #     nessus:
      #       nessus:
      #         - path: /config
      # cache:
      #   type: emptyDir
      #   advancedMounts:
      #     nessus:
      #       nessus:
      #         - path: /tmp
    service:
      nessus:
        controller: nessus
        ports:
          http:
            enabled: true
            primary: true
            port: 8834
            protocol: TCP
            targetPort: 8834
      nessus-lb:
        enabled: true
        controller: nessus
        primary: false
        type: LoadBalancer
        externalTrafficPolicy: Cluster
        labels:
          io.cilium/bgp-announce: worker
        annotations:
          io.cilium/lb-ipam-ips: "${CLUSTER_LB_NESSUS}"
        ports:
          http:
            port: 8834
    ingress:
      nessus:
        enabled: true
        annotations:
          external-dns.alpha.kubernetes.io/hostname: ${INGRESSROUTE_SUBDOMAIN}.${FAMILY_DOMAIN}
          external-dns.alpha.kubernetes.io/target: ${CLUSTER_LB_INGRESS_INTERNAL}
        labels: {}
        className: traefik-internal
        hosts:
          - host: ${INGRESSROUTE_SUBDOMAIN}.${FAMILY_DOMAIN}
            paths:
              - path: /
                pathType: Prefix
                service:
                  name: nessus
                  port: 8834
        tls:
          - secretName: heyjohn-wildcard-certificate
            hosts:
              - ${INGRESSROUTE_SUBDOMAIN}.${FAMILY_DOMAIN}

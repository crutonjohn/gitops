---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: mediamtx-rclone
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mediamtx-rclone
spec:
  concurrencyPolicy: Forbid
  schedule: "45 5/12 * * *" # Twice a day at 5:45 && 17:45
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 10
  startingDeadlineSeconds: 60
  timeZone: "${LOCAL_TIMEZONE}"
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        spec:
          serviceAccountName: mediamtx-rclone
          restartPolicy: Never
          containers:
            - name: rclone
              image: rclone/rclone:latest@sha256:9f59fda717a48aced38d7f27e9ec8fd9992b5651e7a03897bebf204d3a9197d6
              command: ["rclone"]
              args:
                - "move"
                - "--transfers=1"
                - "-P"
                - "--config"
                - "/rclone.conf"
                - "--ca-cert"
                - "/ca.crt"
                - "--include"
                - "'*.mp4'"
                - "/recordings/"
                - "garage-stream-recordings:stream-recordings/crutonjohn/"
              volumeMounts:
                - name: mediamtx-rclone-config
                  mountPath: /rclone.conf
                  subPath: rclone.conf
                  readOnly: true
                - name: mediamtx-recordings
                  mountPath: /recordings
                - name: heyjohn-internal-ca
                  mountPath: /ca.crt
                  subPath: ca.crt
                  readOnly: true
          volumes:
            - name: heyjohn-internal-ca
              secret:
                secretName: heyjohn-internal-ca
            - name: mediamtx-rclone-config
              secret:
                secretName: mediamtx-rclone-config
            - name: mediamtx-recordings
              persistentVolumeClaim:
                claimName: mediamtx-recordings
